<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Card Smith</title>
  <link rel="stylesheet" href="card.css">
  <link href="//cdn.jsdelivr.net/npm/mana-font@latest/css/mana.css" rel="stylesheet" type="text/css" />
</head>

<body>
  <!-- <header>
    <form id="cardForm" onsumbit="makeCard">
      <input type="text" placeholder="Card Name">
      <input type="submit" value="Create Card">
    </form>
  </header> -->

  <!-- CARD TEMPLATE -->
  <!-- <div class="card blue">
    <div class="card-border">
      <div class="color-border">
        <div class="bar top">
          <div class="card-name">Changeling Heir</div>
          <div class="mana-cost">{2}{b}{g}</div>
        </div>
        <div class="card-image"><img
            src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/5a590b8b-443c-401f-b019-8d3153471e1d/dccziyi-40c0d83e-d25d-4964-9b99-2c34effb02e1.png/v1/fill/w_1280,h_1146,q_80,strp/thorax_by_quvr_dccziyi-fullview.jpg?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7ImhlaWdodCI6Ijw9MTE0NiIsInBhdGgiOiJcL2ZcLzVhNTkwYjhiLTQ0M2MtNDAxZi1iMDE5LThkMzE1MzQ3MWUxZFwvZGNjeml5aS00MGMwZDgzZS1kMjVkLTQ5NjQtOWI5OS0yYzM0ZWZmYjAyZTEucG5nIiwid2lkdGgiOiI8PTEyODAifV1dLCJhdWQiOlsidXJuOnNlcnZpY2U6aW1hZ2Uub3BlcmF0aW9ucyJdfQ.UGYycRoE4baaP9SoHpPHc5LiKPaUA1fMDhHn0Azj2Gg"
            alt="Changeling Heir Art"></div>
        <div class="bar middle">
          <div class="type">
            <div class="super-type">Creature</div> &dash;
            <div class="sub-type">Changeling</div>
          </div>
          <div class="set-symbol">???</div>
        </div>
        <div class="card-text">
          <div class="oracle">
            <p>Flying</p>
            <p>
              Mimic {x} <i>(This creature becomes a copy of target creature with converted mana cost X or less until
                end of turn, it is a changeling in addition to its other types.)</i>
            </p>
          </div>
          <hr>
          <div class="flavour">
            <p>
              <i>A Changeling Heir can breed up to seventeen times a day, and bare hundreds of offspring
                whenever the Queen is in hibernation. This continues the growth of a hive all year round.</i></p>
          </div>
          <div class="pt">
            <div class="power">2</div>/<div class="toughness">4</div>
          </div>
        </div>
      </div>
      <div class="collector-info">
        <div class="line">
          <div class="collector-number">1/1</div>
          <div class="rarity">U</div>
        </div>
        <div class="line">
          <div class="set">???</div>&nbsp;&bull;&nbsp;<div class="language">EN</div>
          <div class="artist">Quver</div>
          <div class="left trademark">&copy; Copyright 2019 - LuHeGi Card Smith</div>
        </div>
      </div>
    </div>
  </div> -->

  <!-- Mana Symbols -->
  <script>
    function applyMTGSymbols(el) {
      el.innerHTML = el.innerHTML.replace(
        /(\{)([wubregcxyz0-9]{1})(\})/gi,
        (s, a, b, c) => `<i class="ms ms-cost ms-shadow ms-${b}"></i>`.toLowerCase()
      ).replace(
        /(\{)(tap)?([tT]?)(\})/gi,
        (s, a, b, c) => `<i class="ms ms-cost ms-shadow ms-tap"></i>`.toLowerCase()
      ).replace(
        /(\{)([wubregcxyz0-9]{1})(\/)([wubregcxyz0-9]{1})(\})/gi,
        (s, a, b, c, d, e) => `<i class="ms ms-cost ms-shadow ms-${b}${d}"></i>`.toLowerCase()
      ).replace(
        /(\{)(art)(\})/gi,
        (s, a, b, c) => `<i class="ms ms-artist-nib"></i>`.toLowerCase()
      );
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.js"></script>
  <script>
    const $ = (type, classes = "", content = undefined) => {
      let el = document.createElement(type);
      if (classes.length > 0) {
        for (let claz of classes.split(" ")) {
          el.classList.add(claz);
        }
      }
      if (content) {
        if (type === "img") {
          let data = content.split(" ");
          el.src = data[0];
          el.alt = data[1];
        } else if (typeof (content) === "string") {
          el.textContent = content;
        } else if (typeof (content) === "function") {
          el.innerHTML = content();
        } else if (Array.isArray(content)) {
          for (let child of content) {
            el.append(child);
          }
        }
      }
      return el;
    }
    const dataCols = {
      "name": 2,
      "manacost": 3,
      "cmc": 4,
      "typeline": 5,
      "set": 6,
      "rarity": 7,
      "oracle": 8,
      "power": 9,
      "toughness": 10,
      "loyalty": 11,
      "color_identity": 12,
      "art": 14,
      "artist": 15,
      "flavour": 16
    };
    const tsvURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ5wlrazSE80LIK94JgVbm6h_EvPjwT4nkBQbAiPSJiO6wzY8yVhzkhfA-tETI0zuhHH841f6tQwXJ/pub?gid=50856066&single=true&output=tsv';
    let cardDb = {};
    fetch(tsvURL)
      .then(x => x.text())
      .then(processTSV);


    function processRow(rowValues) {
      let cardData = {};
      for (let dataName in dataCols) {
        cardData[dataName] = rowValues[dataCols[dataName]];
      }
      return cardData;
    }

    function processTSV(data) {
      let rows = data.split('\n');
      for (let i = 2; i < rows.length; i++) {
        let row = rows[i];
        let cardData = processRow(row.split('\t'));
        cardDb[cardData["name"]] = cardData;
      }
      for (let cardName in cardDb) {
        document.body.append(generateCard(cardDb[cardName]));
      }
    }

    function getColor(colorData) {
      let color_id = colorData["color_identity"]
      let color = []
      if (color_id.length === 0 || colorData["typeline"].includes("Land"))
        color.push("colorless");
      if (color_id.includes("{W}"))
        color.push("white");
      if (color_id.includes("{U}"))
        color.push("blue");
      if (color_id.includes("{B}"))
        color.push("black");
      if (color_id.includes("{R}"))
        color.push("red");
      if (color_id.includes("{G}"))
        color.push("green");
      if (color.length > 1)
        color.push("gold");
      return color.join(' ');
    }

    function generateCard(cardData) {
      let color = getColor(cardData)

      let cardEl = $("div", `card ${color}`, [
        $("div", "card-border", [
          $("div", "color-border", [
            $("div", "bar top", [
              $("div", "card-name", cardData["name"]),
              $("div", "mana-cost", cardData["manacost"].toLowerCase())
            ]),
            $("div", "card-image", [
              $("img", "", cardData.art + " art")
            ]),
            $("div", "bar middle", [
              $("div", "type", cardData["typeline"]),
              $("div", "set-symbol", cardData["set"] + "|" + cardData["rarity"])
            ]),
            $("div", "card-text", [
              $("div", "oracle", () => {
                let oracle = cardData["oracle"].replace("{{CARD NAME}}", cardData["name"]);
                let container = $("div");
                let lines = oracle.split("<br>");
                for (let line of lines) {
                  container.append($("p", "", () => line));
                }
                applyMTGSymbols(container);
                container.querySelectorAll(".ms").forEach((el) => el.classList.remove("ms-shadow"))
                return container.innerHTML;
              }),
              $("hr"),
              $("div", "flavour", [
                $("i", "", cardData["flavour"])
              ]),
              $("div", "pt", [
                $("div", "power", cardData["power"]),
                $("div", "toughness", cardData["toughness"])
              ])
            ])
          ]),
          $("div", "collector-info", [
            $("div", "line", [
              $("div", "collector-number", cardData["collector_number"]),
              $("div", "rarity", cardData["rarity"])
            ]),
            $("div", "line", () => {
              let container = $("div");
              container.append($("div", "set", cardData["set"]));
              container.innerHTML += "&bull;";
              container.append($("div", "language", "EN"))
              container.innerHTML += "{art}";
              container.append($("div", "artist", cardData["artist"]));
              container.append($("div", "left trademark", () => "&copy; Copyright 2019 - LuHeGi Card Smith"));
              return container.innerHTML;
            })
          ])
        ])
      ]);
      applyMTGSymbols(cardEl);
      let remove = { ".pt": [".pt"], ".flavour": ["hr", ".flavour"] };
      for (let key in remove) {
        let x = cardEl.querySelector(key);
        if (x && x.textContent.length === 0) {
          for (let value of remove[key]) {
            cardEl.querySelector(value).remove();
          }
        }
      }
      return cardEl;
    }

    function makeCard(ev) {
      ev.preventDefault();
      let input = ev.srcElement[0];
      let cardName = input.value;
      input.value = "";
      let cardData = cardDb[cardName];
      let card = generateCard(cardData);
      document.body.append(card);
    }
    document.querySelector('form#cardForm').addEventListener("submit", makeCard);
  </script>
</body>

</html>